"use strict";
var ModbusRTU = require("modbus-serial");
var pathExists = require("path-exists");
var merge = require("json-add");
var Promise = require("bluebird");
var lsusbdev = require("lsusbdev");
var client = new ModbusRTU();
var defaults = {
    baud: 9600,
    dev: "/dev/ttyUSB0",
    address: 1
};
if (pathExists.sync("./conf.json")) {
    merge(defaults, require("./conf.json"));
    client.setID(defaults.address);
    if (defaults.hub) {
        lsusbdev().then(function (devis) {
            for (var i = 0; i < devis.length; i++) {
                if (devis[i].hub === defaults.hub) {
                    defaults.dev = devis[i].dev;
                }
            }
            client.connectRTU(defaults.dev, { baudrate: defaults.baud }, start);
        }).catch(function () {
            throw "NO USB FOR SDM";
        });
    }
}
else {
    client.connectRTU(defaults.dev, { baudrate: defaults.baud }, start);
}
function readReg(reg) {
    return new Promise(function (resolve, reject) {
        client.readInputRegisters(reg, 2).then(function (data) {
            resolve(data.buffer.readFloatBE());
        }).catch(function (err) {
            reject(err);
        });
    });
}
var regs = [
    {
        label: "volt",
        phase: 1,
        reg: 0
    },
    {
        label: "volt",
        phase: 2,
        reg: 2
    },
    {
        label: "volt",
        phase: 3,
        reg: 4
    },
    {
        label: "current",
        phase: 1,
        reg: 6
    },
    {
        label: "current",
        phase: 2,
        reg: 8
    },
    {
        label: "current",
        phase: 3,
        reg: 10
    },
    {
        label: "power",
        phase: 1,
        reg: 0
    },
    {
        label: "power",
        phase: 2,
        reg: 0
    },
    {
        label: "power",
        phase: 3,
        reg: 0
    }
];
function start() {
    setTimeout(function () {
        readReg(0).then(function (voltage) {
            console.log(voltage);
        });
    }, 1000);
}

//# sourceMappingURL=data:application/json;base64,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QUssRUFBRSxTQUFTO1FBQ2hCLEtBQUssRUFBRSxDQUFDO1FBQ1IsR0FBRyxFQUFFLENBQUM7S0FDVDtJQUNEO1FBQ0ksS0FBSyxFQUFFLFNBQVM7UUFDaEIsS0FBSyxFQUFFLENBQUM7UUFDUixHQUFHLEVBQUUsQ0FBQztLQUNUO0lBQ0Q7UUFDSSxLQUFLLEVBQUUsU0FBUztRQUNoQixLQUFLLEVBQUUsQ0FBQztRQUNSLEdBQUcsRUFBRSxFQUFFO0tBQ1Y7SUFDRDtRQUNJLEtBQUssRUFBRSxPQUFPO1FBQ2QsS0FBSyxFQUFFLENBQUM7UUFDUixHQUFHLEVBQUUsQ0FBQztLQUNUO0lBQ0Q7UUFDSSxLQUFLLEVBQUUsT0FBTztRQUNkLEtBQUssRUFBRSxDQUFDO1FBQ1IsR0FBRyxFQUFFLENBQUM7S0FDVDtJQUNEO1FBQ0ksS0FBSyxFQUFFLE9BQU87UUFDZCxLQUFLLEVBQUUsQ0FBQztRQUNSLEdBQUcsRUFBRSxDQUFDO0tBQ1Q7Q0FDSixDQUFBO0FBRUQ7SUFFQSxVQUFVLENBQUM7UUFDTCxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVMsT0FBTztZQUM5QixPQUFPLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ3pCLENBQUMsQ0FBQyxDQUFDO0lBR1AsQ0FBQyxFQUFDLElBQUksQ0FBQyxDQUFBO0FBS1AsQ0FBQyIsImZpbGUiOiJpbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbImxldCBNb2RidXNSVFUgPSByZXF1aXJlKFwibW9kYnVzLXNlcmlhbFwiKTtcbmltcG9ydCAqIGFzIHBhdGhFeGlzdHMgZnJvbSBcInBhdGgtZXhpc3RzXCI7XG5pbXBvcnQgbWVyZ2UgPSByZXF1aXJlKFwianNvbi1hZGRcIik7XG5pbXBvcnQgKiBhcyBQcm9taXNlIGZyb20gXCJibHVlYmlyZFwiO1xuaW1wb3J0ICogYXMgYXN5bmMgZnJvbSBcImFzeW5jXCI7XG5cbmltcG9ydCBsc3VzYmRldiA9IHJlcXVpcmUoXCJsc3VzYmRldlwiKTtcblxuXG5sZXQgY2xpZW50ID0gbmV3IE1vZGJ1c1JUVSgpO1xuXG5pbnRlcmZhY2UgSWRlZmF1bHRzIHtcbiAgICBiYXVkPzogbnVtYmVyO1xuICAgIGRldj86IHN0cmluZztcbiAgICBhZGRyZXNzPzogbnVtYmVyO1xuICAgIGh1Yj86IHN0cmluZztcbn1cblxubGV0IGRlZmF1bHRzID0gPElkZWZhdWx0cz57XG4gICAgYmF1ZDogOTYwMCxcbiAgICBkZXY6IFwiL2Rldi90dHlVU0IwXCIsXG4gICAgYWRkcmVzczogMVxufTtcblxuaWYgKHBhdGhFeGlzdHMuc3luYyhcIi4vY29uZi5qc29uXCIpKSB7XG5cbiAgICBtZXJnZShkZWZhdWx0cywgcmVxdWlyZShcIi4vY29uZi5qc29uXCIpKTtcblxuICAgIGNsaWVudC5zZXRJRChkZWZhdWx0cy5hZGRyZXNzKTtcblxuXG4gICAgaWYgKGRlZmF1bHRzLmh1Yikge1xuICAgICAgICBsc3VzYmRldigpLnRoZW4oZnVuY3Rpb24oZGV2aXMpIHtcblxuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBkZXZpcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIGlmIChkZXZpc1tpXS5odWIgPT09IGRlZmF1bHRzLmh1Yikge1xuICAgICAgICAgICAgICAgICAgICBkZWZhdWx0cy5kZXYgPSBkZXZpc1tpXS5kZXY7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY2xpZW50LmNvbm5lY3RSVFUoZGVmYXVsdHMuZGV2LCB7IGJhdWRyYXRlOiBkZWZhdWx0cy5iYXVkIH0sIHN0YXJ0KTtcbiAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICB0aHJvdyBcIk5PIFVTQiBGT1IgU0RNXCI7XG4gICAgICAgIH0pO1xuICAgIH1cblxufSBlbHNlIHtcbiAgICBjbGllbnQuY29ubmVjdFJUVShkZWZhdWx0cy5kZXYsIHsgYmF1ZHJhdGU6IGRlZmF1bHRzLmJhdWQgfSwgc3RhcnQpO1xufVxuXG5cbmZ1bmN0aW9uIHJlYWRSZWcocmVnOiBudW1iZXIpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAgIGNsaWVudC5yZWFkSW5wdXRSZWdpc3RlcnMocmVnLCAyKS50aGVuKGZ1bmN0aW9uKGRhdGEpIHtcbiAgICAgICAgICAgIHJlc29sdmUoZGF0YS5idWZmZXIucmVhZEZsb2F0QkUoKSk7XG4gICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycikge1xuICAgICAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuXG59XG5cbmxldCByZWdzID0gW1xuICAgIHtcbiAgICAgICAgbGFiZWw6IFwidm9sdFwiLFxuICAgICAgICBwaGFzZTogMSxcbiAgICAgICAgcmVnOiAwXG4gICAgfSxcbiAgICB7XG4gICAgICAgIGxhYmVsOiBcInZvbHRcIixcbiAgICAgICAgcGhhc2U6IDIsXG4gICAgICAgIHJlZzogMlxuICAgIH0sXG4gICAge1xuICAgICAgICBsYWJlbDogXCJ2b2x0XCIsXG4gICAgICAgIHBoYXNlOiAzLFxuICAgICAgICByZWc6IDRcbiAgICB9LFxuICAgIHtcbiAgICAgICAgbGFiZWw6IFwiY3VycmVudFwiLFxuICAgICAgICBwaGFzZTogMSxcbiAgICAgICAgcmVnOiA2XG4gICAgfSxcbiAgICB7XG4gICAgICAgIGxhYmVsOiBcImN1cnJlbnRcIixcbiAgICAgICAgcGhhc2U6IDIsXG4gICAgICAgIHJlZzogOFxuICAgIH0sXG4gICAge1xuICAgICAgICBsYWJlbDogXCJjdXJyZW50XCIsXG4gICAgICAgIHBoYXNlOiAzLFxuICAgICAgICByZWc6IDEwXG4gICAgfSxcbiAgICB7XG4gICAgICAgIGxhYmVsOiBcInBvd2VyXCIsXG4gICAgICAgIHBoYXNlOiAxLFxuICAgICAgICByZWc6IDBcbiAgICB9LFxuICAgIHtcbiAgICAgICAgbGFiZWw6IFwicG93ZXJcIixcbiAgICAgICAgcGhhc2U6IDIsXG4gICAgICAgIHJlZzogMFxuICAgIH0sXG4gICAge1xuICAgICAgICBsYWJlbDogXCJwb3dlclwiLFxuICAgICAgICBwaGFzZTogMyxcbiAgICAgICAgcmVnOiAwXG4gICAgfVxuXVxuXG5mdW5jdGlvbiBzdGFydCgpIHtcblxuc2V0VGltZW91dChmdW5jdGlvbigpe1xuICAgICAgcmVhZFJlZygwKS50aGVuKGZ1bmN0aW9uKHZvbHRhZ2UpIHtcbiAgICAgICAgY29uc29sZS5sb2codm9sdGFnZSk7XG4gICAgfSk7XG5cbiAgXG59LDEwMDApXG5cblxuXG5cbn1cblxuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
